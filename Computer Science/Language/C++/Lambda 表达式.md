Lambda è¡¨è¾¾å¼ï¼ˆLambda Expressionï¼‰æ˜¯ C++11 å¼•å…¥çš„æœ€é‡è¦ç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒå…è®¸ä½ å®šä¹‰ä¸€ä¸ª**åŒ¿åå‡½æ•°å¯¹è±¡**ï¼ˆClosure/é—­åŒ…ï¼‰ã€‚

ç®€å•æ¥è¯´ï¼Œå°±æ˜¯**åœ¨å‡½æ•°é‡Œé¢å†™å‡½æ•°**ï¼Œå¹¶ä¸”å¯ä»¥ç›´æ¥ä½œä¸ºå‚æ•°ä¼ é€’ç»™ç®—æ³•ï¼ˆå¦‚ `sort`ï¼‰ï¼Œè€Œä¸éœ€è¦ä¸“é—¨å»å¤–é¢å†™ä¸€ä¸ªå‡½æ•°æˆ–ä»¿å‡½æ•°ç±»ã€‚

å®ƒçš„æ ‡å‡†è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š

```cpp
[æ•è·åˆ—è¡¨](å‚æ•°åˆ—è¡¨) mutable -> è¿”å›ç±»å‹ { å‡½æ•°ä½“ }
```

æˆ‘ä»¬æŠŠå®ƒæ‹†è§£ä¸º **5 ä¸ªæ ¸å¿ƒéƒ¨åˆ†** ä¸€æ­¥ä¸€æ­¥è®²è§£ã€‚

---

### 1. æ•è·åˆ—è¡¨ `[]` (Capture Clause) â€”â€” âš ï¸ æœ€æ ¸å¿ƒ

è¿™æ˜¯ Lambda çš„çµé­‚ã€‚æ™®é€šå‡½æ•°åªèƒ½ç”¨ä¼ å…¥çš„å‚æ•°ï¼Œè€Œ Lambda å¯ä»¥**æ•è·**å®ƒæ‰€åœ¨ä½œç”¨åŸŸï¼ˆæ¯”å¦‚ `main` å‡½æ•°é‡Œï¼‰çš„å±€éƒ¨å˜é‡ã€‚

`[]` æ”¾åœ¨æœ€å‰é¢ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨æˆ‘ä»¬è¦â€œæŠ“â€å“ªäº›å¤–éƒ¨å˜é‡è¿›æ¥çœ‹ã€‚

| è¯­æ³• | å«ä¹‰ |
| :--- | :--- |
| **`[]`** | ä¸æ•è·ä»»ä½•å¤–éƒ¨å˜é‡ï¼ˆåªèƒ½ç”¨å‚æ•°ï¼‰ã€‚ |
| **`[x]`** | **æŒ‰å€¼æ•è·** xã€‚ç›¸å½“äºæ‹·è´äº†ä¸€ä»½ x è¿›æ¥ï¼ˆåªè¯»ï¼‰ã€‚ |
| **`[&x]`** | **æŒ‰å¼•ç”¨æ•è·** xã€‚ç›¸å½“äºç»™ x èµ·äº†ä¸ªåˆ«åï¼Œå¯ä»¥ä¿®æ”¹åŸå˜é‡ã€‚ |
| **`[=]`** | **éšå¼æŒ‰å€¼æ•è·**æ‰€æœ‰å˜é‡ã€‚ç¼–è¯‘å™¨è‡ªåŠ¨åˆ¤æ–­ä½ ç”¨äº†è°ï¼Œå°±æ‹·è´è°ã€‚ |
| **`[&]`** | **éšå¼æŒ‰å¼•ç”¨æ•è·**æ‰€æœ‰å˜é‡ã€‚ |
| **`[=, &x]`** | æ··åˆä½¿ç”¨ï¼šé»˜è®¤å…¨æŒ‰å€¼æ•è·ï¼Œä½†å”¯ç‹¬ x æŒ‰å¼•ç”¨æ•è·ã€‚ |

#### ä»£ç ç¤ºä¾‹

```cpp
#include <iostream>
using namespace std;

int main() {
    int a = 10;
    int b = 20;

    // 1. ä¸æ•è· []
    // auto func1 = []() { cout << a; }; // âŒ ç¼–è¯‘é”™è¯¯ï¼Œçœ‹ä¸è§ a

    // 2. æŒ‰å€¼æ•è· [a]
    auto func2 = [a]() { 
        cout << "In func2: " << a << endl; 
    };
    
    // 3. æŒ‰å¼•ç”¨æ•è· [&b] (å¯ä»¥ç›´æ¥ä¿®æ”¹å¤–é¢çš„ b)
    auto func3 = [&b]() {
        b++; // ä¿®æ”¹çš„æ˜¯å¤–é¢çš„ b
        cout << "In func3: " << b << endl;
    };

    // 4. éšå¼æ•è· [=] (è‡ªåŠ¨æŠŠ aå’Œb éƒ½æ‹·è¿›æ¥)
    auto func4 = [=]() {
        cout << "Sum: " << a + b << endl;
    };

    a = 999; // ä¿®æ”¹å¤–éƒ¨çš„ aï¼Œä¸ä¼šå½±å“å·²ç»æŒ‰å€¼æ•è·çš„ func2
    func2(); // è¾“å‡º 10 (å› ä¸ºåˆ›å»º Lambda é‚£ä¸€åˆ»å°±æ‹·è´äº†)
    
    func3(); // è¾“å‡º 21 (b è¢«æ”¹äº†)
    cout << "Outer b: " << b << endl; // è¾“å‡º 21

    return 0;
}
```

---

### 2. å‚æ•°åˆ—è¡¨ `()` (Parameter List)

å’Œæ™®é€šå‡½æ•°çš„å‚æ•°åˆ—è¡¨å®Œå…¨ä¸€æ ·ã€‚
*   å¦‚æœä¸éœ€è¦ä¼ å‚ï¼Œ`()` å¯ä»¥çœç•¥ï¼ˆä½†åœ¨ C++11 ä¸­å»ºè®®å†™ä¸Šï¼ŒC++23 æ‰å…è®¸å®Œå…¨çœç•¥ï¼‰ã€‚
*   **C++14 æ–°ç‰¹æ€§**ï¼šå‚æ•°ç±»å‹å¯ä»¥ä½¿ç”¨ **`auto`**ï¼ˆæ³›å‹ Lambdaï¼‰ã€‚

#### ä»£ç ç¤ºä¾‹

```cpp
#include <iostream>
#include <string>
using namespace std;

int main() {
    // 1. æ™®é€šå‚æ•°
    auto add = [](int x, int y) {
        return x + y;
    };
    cout << add(1, 2) << endl; // 3

    // 2. æ³›å‹å‚æ•° (auto) â€”â€” æå…¶å¼ºå¤§
    // è¿™ä¸ª lambda æ—¢èƒ½åŠ æ•´æ•°ï¼Œä¹Ÿèƒ½åŠ å­—ç¬¦ä¸²
    auto genericAdd = [](auto x, auto y) {
        return x + y;
    };

    cout << genericAdd(10, 20) << endl;          // 30
    cout << genericAdd(string("Hi "), "Tom") << endl; // "Hi Tom"
    
    return 0;
}
```

---

### 3. å¯å˜è§„æ ¼ `mutable` (Mutable Specification) â€”â€” âš ï¸ æ˜“é”™ç‚¹

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**æŒ‰å€¼æ•è· (`[x]`)** çš„å˜é‡åœ¨ Lambda å†…éƒ¨æ˜¯ **`const` (åªè¯»)** çš„ã€‚
å³ä½¿ä½ æŠŠå˜é‡æ‹·è´è¿›æ¥äº†ï¼Œä½ ä¹Ÿä¸èƒ½ä¿®æ”¹è¿™ä¸ªæ‹·è´ï¼Œé™¤éåŠ ä¸Š `mutable` å…³é”®å­—ã€‚

*   æ³¨æ„ï¼š`mutable` ä¿®æ”¹çš„æ˜¯**æ‹·è´è¿›æ¥çš„é‚£ä»½**ï¼Œ**ä¸ä¼š**å½±å“å¤–é¢çš„åŸå˜é‡ã€‚

#### ä»£ç ç¤ºä¾‹

```cpp
#include <iostream>
using namespace std;

int main() {
    int val = 10;

    // âŒ é”™è¯¯å†™æ³•
    // auto f1 = [val]() {
    //     val++; // æŠ¥é”™ï¼val åœ¨è¿™é‡Œæ˜¯ const çš„
    // };

    // âœ… æ­£ç¡®å†™æ³•ï¼šåŠ ä¸Š mutable
    auto f2 = [val]() mutable {
        val++; 
        cout << "Inner val: " << val << endl;
    };

    f2(); // è¾“å‡º Inner val: 11
    cout << "Outer val: " << val << endl; // è¾“å‡º 10 (å¤–é¢æ²¡å˜ï¼)
    
    return 0;
}
```

---

### 4. è¿”å›ç±»å‹ `-> type` (Return Type)

Lambda ä¼šè‡ªåŠ¨æ¨å¯¼è¿”å›ç±»å‹ï¼Œæ‰€ä»¥é€šå¸¸**ä¸éœ€è¦å†™**ã€‚
ä½†åœ¨ä¸€äº›å¤æ‚æƒ…å†µï¼ˆä¾‹å¦‚å‡½æ•°ä½“å†…æœ‰å¤šä¸ªä¸åŒç±»å‹çš„ `return` è¯­å¥ï¼Œæˆ–è€…æƒ³æ˜ç¡®æŒ‡å®šè¿”å›ç±»å‹ï¼‰ä¸‹ï¼Œéœ€è¦ä½¿ç”¨ **åç½®è¿”å›ç±»å‹** è¯­æ³•ã€‚

#### ä»£ç ç¤ºä¾‹

```cpp
// 1. è‡ªåŠ¨æ¨å¯¼ (æ¨è)
auto f1 = [](int x) { return x * 2; }; 

// 2. æ˜¾å¼æŒ‡å®šè¿”å›ç±»å‹ (-> double)
auto f2 = [](int x) -> double {
    if (x % 2 == 0) return x / 2.0;
    else return x * 1.5;
};
```

---

### 5. å‡½æ•°ä½“ `{}` (Function Body)

è¿™å°±ä¸ç”¨å¤šè¯´äº†ï¼Œå’Œæ™®é€šå‡½æ•°ä½“ä¸€æ ·ï¼Œå†™ä½ çš„é€»è¾‘ä»£ç ã€‚

---

### âš¡ ç»¼åˆå®æˆ˜ï¼šç»“åˆ STL ä½¿ç”¨

è¿™æ˜¯ Lambda æœ€å¸¸ç”¨çš„åœºæ™¯ï¼Œé…åˆ `<algorithm>` åº“ã€‚

#### åœºæ™¯ï¼šæŒ‰â€œç»å¯¹å€¼å¤§å°â€å¯¹æ•°ç»„è¿›è¡Œæ’åº

```cpp
#include <iostream>
#include <vector>
#include <algorithm> // for sort
#include <cmath>     // for abs
using namespace std;

int main() {
    vector<int> v = {-10, 5, -2, 8, 1};

    // è¯­æ³•ï¼š[æ•è·](å‚æ•°) { é€»è¾‘ }
    // æˆ‘ä»¬ä¸éœ€è¦æ•è·å¤–éƒ¨å˜é‡ï¼Œæ‰€ä»¥ç”¨ []
    sort(v.begin(), v.end(), [](int a, int b) {
        // è‡ªå®šä¹‰æ¯”è¾ƒé€»è¾‘ï¼šæŒ‰ç»å¯¹å€¼ä»å°åˆ°å¤§æ’
        return abs(a) < abs(b);
    });

    // C++11 èŒƒå›´ for å¾ªç¯
    for (int n : v) cout << n << " ";
    // è¾“å‡º: 1 -2 5 8 -10
    
    return 0;
}
```

---

### âš ï¸ é«˜çº§é™·é˜±ï¼šæ‚¬ç©ºå¼•ç”¨ (Dangling Reference)

è¿™æ˜¯ä½¿ç”¨ Lambda æ—¶æœ€å±é™©çš„é”™è¯¯ã€‚
å¦‚æœä½ **æŒ‰å¼•ç”¨æ•è· (`[&]`)** äº†ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œç„¶åæŠŠè¿™ä¸ª Lambda **è¿”å›**å‡ºå»äº†æˆ–è€…**å­˜**èµ·æ¥äº†ï¼Œç­‰ Lambda çœŸæ­£æ‰§è¡Œæ—¶ï¼Œé‚£ä¸ªå±€éƒ¨å˜é‡å¯èƒ½å·²ç»é”€æ¯äº†ã€‚

```cpp
#include <functional>

// å®šä¹‰ä¸€ä¸ªå‡½æ•°ç±»å‹
using Func = std::function<void()>;

Func createLambda() {
    int temp = 100;
    // âš ï¸ å±é™©ï¼æŒ‰å¼•ç”¨æ•è·äº†å±€éƒ¨å˜é‡ temp
    return [&temp]() { 
        // temp åœ¨ createLambda ç»“æŸæ—¶å°±è¢«é”€æ¯äº†ï¼
        // è¿™é‡Œè®¿é—®çš„æ˜¯é‡æŒ‡é’ˆ/éæ³•å†…å­˜ï¼
        cout << temp << endl; 
    }; 
}

int main() {
    Func f = createLambda();
    f(); // ğŸ’¥ ç¨‹åºå´©æºƒæˆ–æ‰“å°ä¹±ç  (Undefined Behavior)
    return 0;
}
```

**ä¿®æ­£**ï¼šè¿™ç§æƒ…å†µä¸‹å¿…é¡»ä½¿ç”¨ **æŒ‰å€¼æ•è· `[temp]`** æˆ– `[=]`ã€‚

---

### æ€»ç»“é€ŸæŸ¥è¡¨

| å½¢å¼ | ä¾‹å­ | è§£é‡Š |
| :--- | :--- | :--- |
| **åŸºæœ¬è¯­æ³•** | `[x](int a) { return a+x; }` | æ•è· xï¼Œå‚æ•° aã€‚ |
| **åªè¯»é™åˆ¶** | `[x](){ x++; }` | âŒ æŠ¥é”™ï¼Œé»˜è®¤åªè¯»ã€‚ |
| **è§£é™¤é™åˆ¶** | `[x]() mutable { x++; }` | âœ… å…è®¸ä¿®æ”¹ï¼ˆä¿®æ”¹çš„æ˜¯å‰¯æœ¬ï¼‰ã€‚ |
| **ä¿®æ”¹å¤–éƒ¨** | `[&x](){ x++; }` | âœ… å…è®¸ä¿®æ”¹ï¼ˆä¿®æ”¹çš„æ˜¯æœ¬ä½“ï¼‰ã€‚ |
| **æ³›å‹** | `[](auto a, auto b) { ... }` | âœ… å‚æ•°ç±»å‹è‡ªåŠ¨æ¨å¯¼ (C++14)ã€‚ |
| **æœ€ä½³å®è·µ** | `sort(..., [](int a, int b){...})` | éšæ‰‹å†™éšæ‰‹ç”¨ï¼Œé€»è¾‘ç´§å‡‘ã€‚ |